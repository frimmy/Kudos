<html>
{% extends "base.html" %}

<head>
	
	<title>Kudos</title>

</head>
<body>
	{% block content %}


	<div id="main-column" style="position: relative">

		<div class="new_post" style="position: relative">
			<a href="#" id="new-post-modal-btn">
				<div class="new-kudos-button">
					<div class="depth" title="Give Kudos">
						Give Kudos
					</div>
				</div>
			</a>
			<!-- Submit new Kudos -->
			<div class="post-modal">
				<form action='/editpost' class="new_post_form" method="POST" name="add" >
					<!-- inclide csrf token in every form for security -->Â 
					{{ new_post_form.csrf_token }} 
					{% for error in new_post_form.errors.post_body %}
						<!-- <span style="color:red;">[{{error}}]</span>  -->
					{% endfor %}<br />

					<div class="row">
						<div class="col-lg-6">
							<div class ="submit-kudos">
			    				<div class="tags" id="tagsinput_tagsinput" name="tags_div">
										<input type="text" class="tag_input" id="tag_input" name="tag_input" value placeholder="tags"/>
									</div>
			    				<div class="input-group">
			    					<span class="form-control">{{ new_post_form.post_body (class="new-post-body") }} </span>
			    				</div>

			    				<button class="post-button" type="button" id="no-new-post-button" value="cancel">Cancel</button>

				    			<button class="post-button" type="submit" id="new-post-button" name="new_post_btn" value="submit"> Submit </button>

								{{ new_post_form.hidden_tag_ids (class="hidden_tag_ids", id="hidden_tag_ids") }}
								{{ new_post_form.hidden_tag_text (class="hidden_tag_text", id="hidden_tag_text") }}

							</div>
						</div>
					</div>
				</form>
			</div>
		</div>

		<div id="post-column">
<!-- Display posts -->
			{% for post in posts %}
			  {% include 'post.html' with context %}
			{% endfor %}

		</div>
	</div>

	<script type="text/javascript" src="/static/js/jquery1_4_4.min.js"></script>
	<script type='text/javascript' src="/static/js/jquery-ui.min.js"></script>
	<link rel="stylesheet" type="text/css" href="/static/css/jquery-ui.css" />
	<script type="text/javascript" src="/static/js/jquery.tagsinput.js"></script>


	<script type="text/javascript">

		$(document).ready(function(){
			$('.new_post_form').submit(call_collect_tags);

			var tag_words = {{tag_words|safe}}; //safe: tell flask that this input is okay
			var tag_json = {{tag_json|safe}}; 
			var tag_ids = {{tag_ids|safe}};


			$('.tag_input').tagsInput({
				width: 'auto',
				height: '30px',
				autocomplete_list: tag_words,
				autocomplete_dict: tag_json, 
				tag_ids: tag_ids,
			});
		});



		function call_collect_tags(){
			collect_tags($(this))
		}

		function collect_tags(form){

			var all_tags = form.find("span.tag"); //gives you all tags in new post form 
			$.each(all_tags, function(){
				var hidden_tag_ids = form.find(".hidden_tag_ids");
				var hidden_tag_text = form.find(".hidden_tag_text");
				var tag_id = $(this).attr('id');
				hidden_tag_ids.val(hidden_tag_ids.val() + tag_id + "|");
				var tag_text = $(this).children("span").text();
				hidden_tag_text.val(hidden_tag_text.val() + tag_text + "|");
			});
			console.log($(".hidden_tag_ids").val());
		}
		
	

		//GIVE THANKS
	 	$('.thank-button').click(function(e){
        e.preventDefault();
        console.log('clicked' + this.id);
        var button = $(this);
        var data = {
          post_id: this.id
        };
        $.post('/sendthanks', data, function(){
        	console.log("success giving thanks");
        	button.removeClass('thank-button').addClass('thank-button-pressed');

        })
      });

	 	//REMOVE THANKS
	 	$('.thank-button-pressed').click(function(e){
	 		e.preventDefault();
	 		var button = $(this);
	 		var data = {
	 			post_id: this.id
	 		}
		 	$.ajax({
		 		type: 'POST',
		 		url: '/removethanks', 
		 		data: data,
		 		success: function(response){
		 			console.log("success removing thanks");
		 			button.removeClass('thank-button-pressed').addClass('thank-button');
		 			console.log("success");
		 		},
		 		error: function(){
		 			console.log("error removing thanks");
		 		}
		 	})

	 	})


		//REMOVE TAG
		$('.remove-tag').click(function(e) {
			e.preventDefault();
			var avatar = $(this).parent();
			var tagid = avatar.attr('id')
			console.log("tagid: " + tagid)
			var data = {
				tagid: tagid
			}


			$.ajax({
				type: "POST",
				url: '/deletetag/' + tagid,
				data: data,
				success: function(status){
					console.log(status);
					avatar.remove();
				},
				error: function(){
					console.log("error");
				}
			});
			
		});


		//ADD NEW TAG
		$('.submit-new-tag-btn').click(function(e) {
			e.preventDefault();
			console.log('clicked to add tags for: ' + this.id);
			form = $(this).parent()
			collect_tags(form);
			tag_ids = form.find('.hidden_tag_ids').val();
			tag_text = form.find('.hidden_tag_text').val();

			if (tag_ids != ""){
				var data = {
				post_id: this.id,
				tag_ids: tag_ids,
				tag_text: tag_text
				};

				$.post('/newtag', data, function(tag_info){
					form.parent().toggle(); 
					form.children('.tags').children('.tagsinput').children('span').remove(); //remove tag spans from input box
					form.children(".hidden_tag_ids").val(""); //and clear hidden values
					form.children(".hidden_tag_text").val("");
					console.log("tag_dict: " + tag_info);
					//turn tag_info json into usable array - avoidable if specify it's json datatype
					tag_array = jQuery.parseJSON(tag_info);

					//DISPLAY USER AVATARS
					for(var i = 0; i<tag_array.user_tags.length; i++){
						var username = $.trim(tag_array.user_tags[i].username);
						var user_id = tag_array.user_tags[i].user_id;
						var url = '{{url_for("user", username="mskeving")}}'
						new_url = url.replace("mskeving", username)
						var photo = tag_array.user_tags[i].photo;
						var new_avatar = $('<a class="avatar" id=' + user_id + ' href=' + new_url + '><div class="cropper"><img src=' + photo +' alt=' + username + '>');
						console.log("this" + this)
						form.parent().parent().children(".taggees").children(".avatars").append(new_avatar);

					}
					//DISPLAY TEAM AVATARS
					for(var i = 0; i<tag_array.team_tags.length; i++){
						var teamname = tag_array.team_tags[i].teamname;
						var photo = tag_array.team_tags[i].photo;
						var url = '{{url_for("team", team="Baratheon")}}'
						var new_url = url.replace("Baratheon", teamname)
						var new_avatar = $('<a class="avatar" href=' + new_url + '><div class="cropper"><img src=' + photo +' alt=' + teamname + '>');
						console.log("this" + this)
						form.parent().parent().children(".taggees").children(".avatars").append(new_avatar);

					}
				})
			}

			else{
				$(this).add("<span> No new tags </span>");
				e.preventDefault();
				console.log('no new tags');
			}

			
		});

	  	$('.addtag-button').click(function(e){
	  		e.preventDefault();
	  		$(this).parent().parent().children(".tag-modal").toggle();
	  		if ($(this).parents().siblings('.comment-modal').css('display') != 'none') {
	  			$(this).parent().parent().children('.comment-modal').toggle();
	  		};

		});

	 	$('.no_new_tag_btn').click(function(e){
			e.preventDefault();
			$(this).parent().toggle();
		})

	 	//SHOW COMMENT MODAL
		$('.comment-button').click(function(e){
			e.preventDefault();
			$(this).parent().parent().children(".comment-modal").toggle();
			if ($(this).parents().siblings('.tag-modal').css('display') != 'none') {
	  			$(this).parent().parent().children('.tag-modal').toggle();
	  		};
		});

		


		$('#no_new_post_btn').click(function(e) {
			e.preventDefault();
			$('.post-modal').hide();
			$('#post-column').css('margin', '0px');
		});

		$('#new-post-modal-btn').click(function(e) {
			$('.post-modal').toggle();
			if($('.post-modal').css('display')=='none'){
				$('#post-column').css('margin', '0px');
			}
			else{
				$('#post-column').css('margin', '240px 0px 0px 0px');
			};
		});

		//NEW POST - fill in with #new-post-button
		$('#nothing').click(function(e){
			console.log("new post button")
			e.preventDefault();
			collect_tags($('.new_post_form'))
			var data = {
				post_body: $('#new_post_body').val(),
				hidden_tag_ids: $('.hidden_tag_ids').val(),
				hidden_tag_text: $('.hidden_tag_text').val()
			};
			console.log(data);
			$.ajax({
				type: 'POST',
				url: '/editpost',
				data: data,
				success: function(e){
					console.log("success - new comment submitted");
				},
				error: function(e){
					console.log('error creating new post');
				}
			});
			

		});

		//REMOVE COMMENT
		$('.remove-comment').click(function(e){
			e.preventDefault();
			var post_id = $(this).attr('id');
			var comment = $(this).parent().parent()
			var data = {

			}

			$.ajax({
				type: "POST",
				url: '/deletepost/' + post_id,
				data: data,
				success: function(response){
					comment.remove();
					console.log("success");
				}, 
				error: function(){
					console.log("error");
				}
			})
		})

		//NEW COMMENT
		$('.new-comment-btn').click(function(e){
			console.log("in fnc")
			e.preventDefault();
			console.log("in new comment button function");
			var data = {
				post_id: $(this).parent().attr('id'),
				body: $(this).siblings('.reply-body').val()
			}
			console.log(data);
			//get entire comment display to append new comment to
			var comment_display=$(this).parent().parent().parent().parent().siblings('"' + data['post_id'] + '.comments');

			$.ajax({
				type: "POST",
				url: '/newcomment',
				data: data, 
				success: function(comment_info){
					console.log("sucess - new comment submitted");

					var username = comment_info.author_username
					var photo = comment_info.author_photo
					var id = comment_info.comment_id
					var new_avatar = '<a class="avatar" href="{{url_for("user", username="' + username + '")}}"><div class="cropper"><img src=' + photo +' alt=' + username + '>';
					var new_comment = $('<div class="one-comment" id="' + id + '"><div class="clearfix">' + new_avatar) 

					comment_display.append(new_comment);
					//two separate appends to close <a> tag? DOESN'T WORK! 
					new_comment=$('"#' + id + '.one-comment');

					new_comment.append($('<span class="comment-body">' + data["body"] + '<br>'));


				},
				error: function(e){
					console.log('error creating new reply')
				},
				dataType: "json"
			});
		})
		
	</script>
	{% endblock %}
	</body>

</html>


